<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>拉米的小歌單</title>
  <style>
    :root{
      --bg:#0b0e14; --card:#121826; --muted:#9db2ce; --ink:#e6edf7; --acc:#a78bfa;
      --card-h:160px;
      --wrap-w:1100px;
      --header-pad-y: 42px;
      --title-nav-gap: 26px;
      --bg-url: url("lamilan.png");
      --bg-blur: 3px;
      --bg-dim : 0.4;
    }
    *{box-sizing:border-box}
    body{ background: var(--bg); color: var(--ink); }

    body::before{
      content:""; position: fixed; inset: 0;
      background-image: var(--bg-url); background-size: cover; background-position: center;
      filter: blur(var(--bg-blur)) saturate(110%); transform: scale(1.06);
      z-index: -2; pointer-events: none;
    }
    body::after{
      content:""; position: fixed; inset: 0;
      background:
        radial-gradient(1200px 600px at 50% 20%, rgba(0,0,0,0) 0%, rgba(0,0,0,.35) 70%, rgba(0,0,0,.65) 100%),
        rgba(0,0,0, var(--bg-dim));
      z-index: -1; pointer-events: none;
    }

    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,14,20,.95),rgba(11,14,20,.7));backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid #1f2a3a}
    .wrap{max-width:var(--wrap-w);margin:0 auto;padding-top: var(--header-pad-y);padding-bottom: var(--header-pad-y);padding:32px 24px}
    .title{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title h1{font-size:32px;margin:0;flex:1}

    /* 我想點歌按鈕（右上） */
    .request-btn{
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      background:var(--acc);color:#001812;font-size:16px;font-weight:bold;
      border:none;border-radius:12px;padding:10px 18px;cursor:pointer;text-align:center;
      box-shadow:0 6px 16px rgba(167,139,250,.25);
    }
    .request-btn small{font-size:12px;font-weight:normal;margin-top:2px;color:#111}

    nav{display:flex;flex-wrap:wrap;gap:8px;margin-top: var(--title-nav-gap)}
    nav button{background:#0f172a;border:1px solid #253248;color:var(--muted);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:16px}
    nav button.active{color:#001812;background:var(--acc);border-color:transparent}

    main{padding:18px 16px}
    .tools{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
    .tools input,.tools select{background:#0f172a;border:1px solid #273347;color:var(--ink);padding:10px 12px;border-radius:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #24404a;background:#0b2826;color:#cee;padding:6px 10px;border-radius:999px;text-decoration:none}
    .danger{background:#33141b;border-color:#612036}

    /* 「加倍歌單」的次行工具列（恢復原本大小） */
    .subtools{display:none; margin: 8px 0 14px;}
    .subtools.show{display:block;}
    #multOnly{
      padding: 6px 12px; background:#0f172a; border:1px solid #273347; color:var(--ink); border-radius:12px;
    }
    .subtools label{color:var(--ink); margin-right:10px; vertical-align:middle}

    /* ===== 卡片 ===== */
    .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:14px;height:var(--card-h);display:flex;flex-direction:column;align-items:flex-start;justify-content:flex-start;gap:6px}
    .card h3{margin:.2rem 0 .1rem;font-size:20px;line-height:1.25}
    .meta{color:var(--muted);font-size:13px}
    .tag{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2a3a55;color:#a0b9d8;margin-right:6px}
    .footer{color:#789;font-size:12px;margin-top:28px}
    .badge{display:inline-block;margin-left:8px;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid #2a3a55}
    .badge-orange{background:#3a2206;border-color:#6a3f14;color:#ffcc8a} /* x2 */
    .badge-red{background:#331014;border-color:#612036;color:#ff9aa2}    /* x3 */
    .badge-green{background:#0b2b1e;border-color:#1f5a3a;color:#a8f0c8}
    .badge-yellow{background:#2b2b0b;border-color:#5a5a1f;color:#ffe08a}
    .badge-blue{background:#0b2033;border-color:#204a6a;color:#9bd0ff}
    .badge-violet{background:#1b0b2b;border-color:#4a1f5a;color:#d8a0ff}  /* 吉他可點 */
    .badge-tw{background:#0b1b2b;border-color:#1f4a6a;color:#a0d8ff}      /* 台語 */
    .empty{opacity:.8;border:1px dashed #2a3b5a;border-radius:14px;padding:20px;text-align:center}
    a.link{color:var(--acc)}

    /* 兩欄列表 */
    .grid-all{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:680px){ .grid-all{grid-template-columns:repeat(2,1fr)} }

    /* 左歌手右歌曲 */
    .twoPane{display:grid;gap:16px}
    @media(min-width:900px){.twoPane{grid-template-columns:280px 1fr}}
    .pane-left{background:var(--card);border:1px solid #1e293b;border-radius:14px;padding:8px;max-height:72vh;overflow:auto}
    .pane-right{display:grid;grid-template-columns:1fr;gap:12px;align-content:start;align-items:start}
    .artist-item{padding:10px 12px;border-radius:10px;cursor:pointer;color:var(--muted);display:flex;justify-content:space-between;align-items:center;font-size:16px}
    .artist-item:hover{background:#0f172a;color:var(--ink)}
    .artist-item.active{background:var(--acc);color:#001812}
    .artist-count{font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M9 18V5l10-2v13" stroke="currentColor" stroke-width="1.5"/><circle cx="7" cy="18" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="17" cy="16" r="3" stroke="currentColor" stroke-width="1.5"/></svg>
        <h1>拉米の歌單</h1>
        <button class="request-btn" id="requestBtn">
          我想點歌
          <small>備註填上歌名</small>
        </button>
      </div>
      <nav id="tabs"></nav>
    </div>
  </header>

  <main class="wrap">
    <div class="tools">
      <input id="search" type="search" placeholder="搜尋：歌名 / 歌手 / 備註 / 熟悉度 / 倍數" />
      <select id="lenFilter">
        <option value="">依歌名字數篩選（全部）</option>
        <option value="1-4">1–4 字</option>
        <option value="5-6">5–6 字</option>
        <option value="7-8">7–8 字</option>
        <option value="9+">9 字以上</option>
      </select>
      <a id="sheetLink" class="pill" target="_blank" rel="noopener">查看資料表</a>
      <a class="pill danger" href="#" id="forceReload">立刻重整</a>
    </div>

    <!-- 只有「加倍歌單」顯示 -->
    <div id="multRow" class="subtools">
      <label for="multOnly">加倍歌單篩選：</label>
      <select id="multOnly">
        <option value="x2">雙倍歌單</option>
        <option value="x3">三倍歌單</option>
      </select>
    </div>

    <div id="list"></div>
    <div class="footer">歡迎點歌:D 拉米正努力升級網頁中....。</div>
  </main>

  <script>
  /* ========= 設定 ========= */
  const CONFIG = {
    GAS_URL: "https://script.google.com/macros/s/AKfycbxKRVJ6F3LBQeTLp4yW8h0m7WohmvHo0Nq43nWhX3uQuLluRMq9ih4N8ABrXQ7jRhN0hg/exec",
    SHEET_VIEW_URL: "https://docs.google.com/spreadsheets/d/1dTPu4IdWgHgeHHhtPIh1-543fbGVl6LBU15WYFzhYRs/edit",
    CATEGORY_TABS: ["所有歌曲","女歌手","男歌手","合唱","抖音歌","日文歌","英文歌","其他...","吉他歌單","加倍歌單"]
  };
  const TABS = CONFIG.CATEGORY_TABS.slice();
  let rows=[], filtered=[], activeTab=TABS[0], selectedArtist=null;

  /* ========= JSONP ========= */
  function jsonp(url, timeoutMs=15000){
    return new Promise((resolve,reject)=>{
      const cb="__jsonp__"+Math.random().toString(36).slice(2);
      const s=document.createElement("script");
      const sep=url.includes("?")?"&":"?";
      s.src=url+sep+"callback="+cb;
      const timer=setTimeout(()=>{cleanup();reject(new Error("JSONP timeout"))},timeoutMs);
      function cleanup(){clearTimeout(timer);delete window[cb];s.remove();}
      window[cb]=d=>{cleanup();resolve(d)};
      s.onerror=()=>{cleanup();reject(new Error("JSONP network error"))};
      document.head.appendChild(s);
    });
  }
  function toStr(v){return v==null?"":String(v)}
  function escapeHtml(s){s=toStr(s);return s.replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;"}[m]))}
  function escapeAttr(s){return escapeHtml(s).replace(/"/g,"&quot;")}
  function shuffle(a){const arr=a.slice();for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

  async function fetchSheet(){
    try{
      const url = CONFIG.GAS_URL + (CONFIG.GAS_URL.includes('?') ? '&' : '?') + 'cb=' + Date.now();
      const data = await jsonp(url);
      const arr = Array.isArray(data) ? data : (Array.isArray(data.data) ? data.data : []);
      rows = arr.map(r => r.category!==undefined ? r : ({
        category:r[0], title:r[1], artist:r[2], note:r[3],
        url:r[4], updatedAt:r[5], familiarity:r[6], multiplier:r[7]
      })).filter(x=>x && x.title);
      applyFilters(true);
    }catch(err){
      console.error(err);
      document.getElementById('list').innerHTML =
        `<div class="empty">讀取失敗：${escapeHtml(err.message)}<br>請確認 Web App 為 /exec 且「任何人」可存取。</div>`;
    }
  }

  function renderTabs(){
    const nav=document.getElementById('tabs'); nav.innerHTML='';
    TABS.forEach(cat=>{
      const b=document.createElement('button');
      b.textContent=cat;
      b.className=(cat===activeTab?'active':'');
      b.onclick=()=>{activeTab=cat;applyFilters(true)};
      nav.appendChild(b);
    });
  }

  function famBadgesHTML(famStr){
    const tokens = toStr(famStr).split(/[;|、,]+/).map(s=>s.trim()).filter(Boolean);
    return tokens.map(tok=>`<span class="badge ${badgeClass(tok)}">${escapeHtml(tok)}</span>`).join(' ');
  }

  function applyFilters(resetArtist=false){
    const q = toStr(document.getElementById('search').value).trim().toLowerCase();
    const len = document.getElementById('lenFilter').value;

    const multRow = document.getElementById('multRow');
    const multOnly = document.getElementById('multOnly');
    const isMultiTab = (activeTab==='加倍歌單');
    multRow.classList.toggle('show', isMultiTab);

    let pool = rows.slice();

    if (isMultiTab) {
      const m = multOnly.value || 'x2';
      pool = pool.filter(r => toStr(r.multiplier).toLowerCase()===m);
    } else if (activeTab==='吉他歌單') {
      pool = pool.filter(r => toStr(r.familiarity).includes('吉他可點'));
    } else if (activeTab==='其他...') {
      pool = pool.filter(r => r.category===activeTab);
    } else if (activeTab!=='所有歌曲') {
      pool = pool.filter(r => r.category===activeTab);
    }

    if (q) pool = pool.filter(r=>{
      const hay = (toStr(r.title)+' '+toStr(r.artist)+' '+toStr(r.note)+' '+toStr(r.familiarity)+' '+toStr(r.multiplier)).toLowerCase();
      return hay.includes(q);
    });

    if (len){
      pool = pool.filter(r=>{
        const n=[...toStr(r.title)].length;
        if(len==='1-4') return n>=1&&n<=4;
        if(len==='5-6') return n>=5&&n<=6;
        if(len==='7-8') return n>=7&&n<=8;
        if(len==='9+')  return n>=9;
        return true;
      });
    }

    filtered = (activeTab==='所有歌曲') ? shuffle(pool) : pool;

    if (resetArtist) selectedArtist=null;
    const artistSet = new Set(filtered.map(r=>toStr(r.artist)||'（未填歌手）'));
    if (selectedArtist && !artistSet.has(selectedArtist)) selectedArtist=null;

    renderTabs();
    renderList();
  }

  function renderList(){
    const box=document.getElementById('list'); box.innerHTML='';

    if (!filtered.length){
      box.innerHTML = `<div class="empty">此分頁沒有資料或條件太嚴格 : )</div>`;
      return;
    }

    // 版型 A：所有歌曲 & 加倍歌單（兩欄）
    if (activeTab==='所有歌曲' || activeTab==='加倍歌單'){
      const grid=document.createElement('div'); grid.className='grid-all';
      filtered.forEach(r=> grid.appendChild(songCard(r)));
      box.appendChild(grid);
      return;
    }

    // 其他...：直接列歌（單欄）
    if (activeTab==='其他...'){
      const grid=document.createElement('div'); grid.className='grid-all';
      filtered.forEach(r=> grid.appendChild(songCard(r)));
      box.appendChild(grid);
      return;
    }

    // 版型 B：歌手清單 + 單欄歌曲（吉他歌單、女／男／合唱／抖音／日文／英文）
    const two=document.createElement('div'); two.className='twoPane';
    const left=document.createElement('div'); left.className='pane-left';
    const right=document.createElement('div'); right.className='pane-right';

    const seen=new Set();
    filtered.forEach(r=>{
      const name=toStr(r.artist)||'（未填歌手）';
      if(seen.has(name)) return;
      seen.add(name);
      const count = filtered.filter(x=>toStr(x.artist)===toStr(r.artist)).length;
      const item=document.createElement('div');
      item.className='artist-item'+(name===selectedArtist?' active':'');
      item.innerHTML=`<span>${escapeHtml(name)}</span><span class="artist-count">${count}</span>`;
      item.onclick=()=>{
        selectedArtist=name;
        left.querySelectorAll('.artist-item').forEach(el=>el.classList.remove('active'));
        item.classList.add('active');
        renderSongsFor(right, name);
      };
      left.appendChild(item);
    });

    if (selectedArtist) renderSongsFor(right, selectedArtist);
    else right.innerHTML=`<div class="empty">請在左側點選歌手查看歌曲</div>`;

    two.appendChild(left); two.appendChild(right);
    box.appendChild(two);
  }

  function renderSongsFor(container, artistName){
    container.innerHTML='';
    const list = filtered.filter(r => (toStr(r.artist)||'（未填歌手）')===artistName);
    if (!list.length){ container.innerHTML=`<div class="empty">沒有符合的歌曲</div>`; return; }
    list.forEach(r => container.appendChild(songCard(r)));
  }

  function songCard(r){
    const div=document.createElement('div');
    div.className='card';
    const link = r.url ? `<a class="link" href="${escapeAttr(r.url)}" target="_blank" rel="noopener">播放/連結</a>` : '';
    const when = r.updatedAt ? new Date(r.updatedAt).toLocaleString() : '';
    const famHTML = famBadgesHTML(r.familiarity);
    const mult = toStr(r.multiplier).toLowerCase();
    const multHTML = mult==='x2' ? `<span class="badge badge-orange">x2</span>` :
                     mult==='x3' ? `<span class="badge badge-red">x3</span>` : '';

    div.innerHTML = `
      <div class="meta">
        <span class="tag">${escapeHtml(r.category||'未分類')}</span>
        ${famHTML}
        ${multHTML}
      </div>
      <h3>${escapeHtml(r.title)}</h3>
      <div class="meta">${escapeHtml(r.artist||'')}</div>
      <div class="meta" style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
        <span>${when? '更新：'+escapeHtml(when) : ''}</span>
        <span>${link}</span>
      </div>`;
    return div;
  }

  function badgeClass(token){
    const t = toStr(token);
    if (/可點機掰版/.test(t)) return 'badge-green';
    if (/^熟$/.test(t))       return 'badge-yellow';
    if (/不熟/.test(t))       return 'badge-blue';
    if (/吉他可點/.test(t))   return 'badge-violet';
    if (/台語/.test(t))       return 'badge-tw';
    return '';
  }

  // 點擊「我想點歌」按鈕，跳轉到綠界抖內頁面
  document.getElementById('requestBtn').addEventListener('click', ()=>{
    window.open('https://p.ecpay.com.tw/A951DE5', '_blank');
  });

  /* 綁事件 + 啟動 */
  document.getElementById('search').addEventListener('input', ()=>applyFilters(true));
  document.getElementById('lenFilter').addEventListener('change', ()=>applyFilters(true));
  document.getElementById('multOnly').addEventListener('change', ()=>applyFilters(true));
  document.getElementById('forceReload').addEventListener('click', e=>{e.preventDefault();fetchSheet()});
  document.getElementById('sheetLink').href = CONFIG.SHEET_VIEW_URL;

  renderTabs();
  fetchSheet();
  setInterval(fetchSheet, 86400000);
  </script>
</body>
</html>

